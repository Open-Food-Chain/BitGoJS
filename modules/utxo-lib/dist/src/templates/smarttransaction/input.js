// OP_0 [signatures ...]
var Buffer = require('safe-buffer').Buffer;
var bscript = require('../../script');
var p2sto = require('./output');
var typeforce = require('typeforce');
var varuint = require('varuint-bitcoin');
var OPS = require('bitcoin-ops');
function partialSignature(value) {
    return value === OPS.OP_0 || bscript.isCanonicalSignature(value);
}
class SmartTransactionSignature {
    constructor(version = 1, sigType = 1, pubKeyData, oneSignature) {
        this.sigType = sigType;
        this.pubKeyData = pubKeyData;
        this.oneSignature = oneSignature;
    }
    fromBuffer(buffer, initialOffset) {
        var offset = initialOffset || 0;
        function readSlice(n) {
            offset += n;
            return buffer.slice(offset - n, offset);
        }
        function readUInt8() {
            var i = buffer.readUInt8(offset);
            offset += 1;
            return i;
        }
        function readVarInt() {
            var vi = varuint.decode(buffer, offset);
            offset += varuint.decode.bytes;
            return vi;
        }
        function readVarSlice() {
            return readSlice(readVarInt());
        }
        this.sigType = readUInt8();
        this.pubKeyData = readVarSlice();
        this.oneSignature = readVarSlice();
        return offset;
    }
    __byteLength() {
        return 1 +
            varuint.encodingLength(this.pubKeyData.length) + this.pubKeyData.length +
            varuint.encodingLength(this.oneSignature.length) + this.oneSignature.length;
    }
    toBuffer(buffer, initialOffset) {
        var noBuffer = !buffer;
        if (noBuffer)
            buffer = Buffer.allocUnsafe(this.__byteLength());
        var offset = initialOffset || 0;
        function writeSlice(slice) { offset += slice.copy(buffer, offset); }
        function writeUInt8(i) { offset = buffer.writeUInt8(i, offset); }
        function writeVarInt(i) {
            varuint.encode(i, buffer, offset);
            offset += varuint.encode.bytes;
        }
        function writeVarSlice(slice) { writeVarInt(slice.length); writeSlice(slice); }
        writeUInt8(this.sigType);
        writeVarSlice(this.pubKeyData);
        writeVarSlice(this.oneSignature);
        // avoid slicing unless necessary
        if (initialOffset !== undefined)
            return noBuffer ? buffer.slice(initialOffset, offset) : offset;
        // TODO (https://github.com/BitGo/bitgo-utxo-lib/issues/11): we shouldn't have to slice the final buffer
        return noBuffer ? buffer.slice(0, offset) : offset;
    }
}
class SmartTransactionSignatures {
    constructor(version = 1, sigHashType = 1, signatures) {
        this.version = version;
        this.sigHashType = sigHashType;
        this.signatures = signatures ? signatures : [];
    }
    isValid() {
        return this.version > 0 && this.version < 2 && bscript.isDefinedHashType(this.sigHashType) && this.signatures.length > 0;
    }
    __byteLength() {
        return this.signatures.reduce(function (a, x) { return a + x.__byteLength(); }, 2 + varuint.encodingLength(this.signatures.length));
    }
    minLength() {
        checkSigs = new SmartTransactionSignatures();
        return checkSigs.__byteLength();
    }
    toBuffer(buffer, initialOffset) {
        var noBuffer = !buffer;
        if (noBuffer)
            buffer = Buffer.allocUnsafe(this.__byteLength());
        var offset = initialOffset || 0;
        function writeSlice(slice) { offset += slice.copy(buffer, offset); }
        function writeUInt8(i) { offset = buffer.writeUInt8(i, offset); }
        function writeVarInt(i) {
            varuint.encode(i, buffer, offset);
            offset += varuint.encode.bytes;
        }
        function writeVarSlice(slice) { writeVarInt(slice.length); writeSlice(slice); }
        function writeVector(vector) {
            this.writeVarInt(vector.length);
            vector.forEach((buf) => this.writeVarSlice(buf));
        }
        writeUInt8(this.version);
        writeUInt8(this.sigHashType);
        writeVarInt(this.signatures ? this.signatures.length : 0);
        this.signatures.array.forEach(x => {
            offset = x.toBuffer(buffer, offset);
        });
        // avoid slicing unless necessary
        if (initialOffset !== undefined)
            return noBuffer ? buffer.slice(initialOffset, offset) : offset;
        // TODO (https://github.com/BitGo/bitgo-utxo-lib/issues/11): we shouldn't have to slice the final buffer
        return noBuffer ? buffer.slice(0, offset) : offset;
    }
    fromBuffer(buffer, initialOffset) {
        var _a;
        var offset = initialOffset || 0;
        function readUInt8() {
            var i = buffer.readUInt8(offset);
            offset += 1;
            return i;
        }
        function readVarInt() {
            var vi = varuint.decode(buffer, offset);
            offset += varuint.decode.bytes;
            return vi;
        }
        function readOneSig() {
            var oneSig = new SmartTransactionSignature();
            offset = oneSig.fromBuffer(buffer, offset);
            return oneSig;
        }
        try {
            if (buffer.length < this.minLength()) {
                return initialOffset || 0;
            }
            this.version = readUInt8();
            this.sigHashType = readUInt8();
            if (!(this.version > 0 && this.version < 2 && bscript.isDefinedHashType(this.sigHashType))) {
                return initialOffset || 0;
            }
            this.signatures = (_a = this.signatures) !== null && _a !== void 0 ? _a : [];
            for (let numSignatures = readVarInt(); numSignatures > 0; numSignatures--) {
                this.signatures[this.signatures.length] = readOneSig();
            }
        }
        catch (error) {
            this.version = 0;
            return initialOffset || 0;
        }
        return offset;
    }
}
function check(chunks) {
    if (chunks.length != 1)
        return false;
    checkSigs = new SmartTransactionSignatures();
    checkSigs.fromBuffer(chunks[0]);
    return checkSigs.isValid();
}
check.toJSON = function () { return 'smart transaction input'; };
var EMPTY_BUFFER = Buffer.allocUnsafe(0);
function encodeStack(signatures, scriptPubKey) {
    typeforce([partialSignature], signatures);
    if (scriptPubKey) {
        var scriptData = p2sto.decode(scriptPubKey);
        if (signatures.length < scriptData.m) {
            throw new TypeError('Not enough signatures provided');
        }
        if (signatures.length > scriptData.pubKeys.length) {
            throw new TypeError('Too many signatures provided');
        }
    }
    return [].concat(EMPTY_BUFFER, signatures.map(function (sig) {
        if (sig === OPS.OP_0) {
            return EMPTY_BUFFER;
        }
        return sig;
    }));
}
function encode(signatures, scriptPubKey) {
    return bscript.compile(encodeStack(signatures, scriptPubKey));
}
function decodeStack(stack, allowIncomplete) {
    typeforce(check, stack, allowIncomplete);
    return stack.slice(1);
}
function decode(buffer, allowIncomplete) {
    var stack = bscript.decompile(buffer);
    return decodeStack(stack, allowIncomplete);
}
module.exports = {
    check: check,
    decode: decode,
    decodeStack: decodeStack,
    encode: encode,
    encodeStack: encodeStack
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5wdXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvdGVtcGxhdGVzL3NtYXJ0dHJhbnNhY3Rpb24vaW5wdXQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsd0JBQXdCO0FBRXhCLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNLENBQUE7QUFDMUMsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFBO0FBQ3JDLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtBQUMvQixJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUE7QUFDcEMsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUE7QUFDeEMsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFBO0FBRWhDLFNBQVMsZ0JBQWdCLENBQUUsS0FBSztJQUM5QixPQUFPLEtBQUssS0FBSyxHQUFHLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUNsRSxDQUFDO0FBRUQsTUFBTSx5QkFBeUI7SUFDN0IsWUFBWSxPQUFPLEdBQUcsQ0FBQyxFQUFFLE9BQU8sR0FBRyxDQUFDLEVBQUUsVUFBVSxFQUFFLFlBQVk7UUFFNUQsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUE7UUFDdEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUE7UUFDNUIsSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUE7SUFDbEMsQ0FBQztJQUVELFVBQVUsQ0FBQyxNQUFNLEVBQUUsYUFBYTtRQUU5QixJQUFJLE1BQU0sR0FBRyxhQUFhLElBQUksQ0FBQyxDQUFBO1FBQy9CLFNBQVMsU0FBUyxDQUFFLENBQUM7WUFDbkIsTUFBTSxJQUFJLENBQUMsQ0FBQTtZQUNYLE9BQU8sTUFBTSxDQUFDLEtB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LGVBQWU7SUFDdEMsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUNyQyxPQUFPLFdBQVcsQ0FBQyxLQUFLLEVBQUUsZUFBZSxDQUFDLENBQUE7QUFDNUMsQ0FBQztBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUc7SUFDZixLQUFLLEVBQUUsS0FBSztJQUNaLE1BQU0sRUFBRSxNQUFNO0lBQ2QsV0FBVyxFQUFFLFdBQVc7SUFDeEIsTUFBTSxFQUFFLE1BQU07SUFDZCxXQUFXLEVBQUUsV0FBVztDQUN6QixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gT1BfMCBbc2lnbmF0dXJlcyAuLi5dXG5cbnZhciBCdWZmZXIgPSByZXF1aXJlKCdzYWZlLWJ1ZmZlcicpLkJ1ZmZlclxudmFyIGJzY3JpcHQgPSByZXF1aXJlKCcuLi8uLi9zY3JpcHQnKVxudmFyIHAyc3RvID0gcmVxdWlyZSgnLi9vdXRwdXQnKVxudmFyIHR5cGVmb3JjZSA9IHJlcXVpcmUoJ3R5cGVmb3JjZScpXG52YXIgdmFydWludCA9IHJlcXVpcmUoJ3ZhcnVpbnQtYml0Y29pbicpXG52YXIgT1BTID0gcmVxdWlyZSgnYml0Y29pbi1vcHMnKVxuXG5mdW5jdGlvbiBwYXJ0aWFsU2lnbmF0dXJlICh2YWx1ZSkge1xuICByZXR1cm4gdmFsdWUgPT09IE9QUy5PUF8wIHx8IGJzY3JpcHQuaXNDYW5vbmljYWxTaWduYXR1cmUodmFsdWUpXG59XG5cbmNsYXNzIFNtYXJ0VHJhbnNhY3Rpb25TaWduYXR1cmUge1xuICBjb25zdHJ1Y3Rvcih2ZXJzaW9uID0gMSwgc2lnVHlwZSA9IDEsIHB1YktleURhdGEsIG9uZVNpZ25hdHVyZSlcbiAge1xuICAgIHRoaXMuc2lnVHlwZSA9IHNpZ1R5cGVcbiAgICB0aGlzLnB1YktleURhdGEgPSBwdWJLZXlEYXRhXG4gICAgdGhpcy5vbmVTaWduYXR1cmUgPSBvbmVTaWduYXR1cmVcbiAgfVxuXG4gIGZyb21CdWZmZXIoYnVmZmVyLCBpbml0aWFsT2Zmc2V0KVxuICB7XG4gICAgdmFyIG9mZnNldCA9IGluaXRpYWxPZmZzZXQgfHwgMFxuICAgIGZ1bmN0aW9uIHJlYWRTbGljZSAobikge1xuICAgICAgb2Zmc2V0ICs9IG5cbiAgICAgIHJldHVybiBidWZmZXIuc2xpY2Uob2Zmc2V0IC0gbiwgb2Zmc2V0KVxuICAgIH1cbiAgXG4gICAgZnVuY3Rpb24gcmVhZFVJbnQ4ICgpIHtcbiAgICAgIHZhciBpID0gYnVmZmVyLnJlYWRVSW50OChvZmZzZXQpXG4gICAgICBvZmZzZXQgKz0gMVxuICAgICAgcmV0dXJuIGlcbiAgICB9XG4gIFxuICAgIGZ1bmN0aW9uIHJlYWRWYXJJbnQgKCkge1xuICAgICAgdmFyIHZpID0gdmFydWludC5kZWNvZGUoYnVmZmVyLCBvZmZzZXQpXG4gICAgICBvZmZzZXQgKz0gdmFydWludC5kZWNvZGUuYnl0ZXNcbiAgICAgIHJldHVybiB2aVxuICAgIH1cbiAgXG4gICAgZnVuY3Rpb24gcmVhZFZhclNsaWNlICgpIHtcbiAgICAgIHJldHVybiByZWFkU2xpY2UocmVhZFZhckludCgpKVxuICAgIH1cblxuICAgIHRoaXMuc2lnVHlwZSA9IHJlYWRVSW50OCgpXG4gICAgdGhpcy5wdWJLZXlEYXRhID0gcmVhZFZhclNsaWNlKClcbiAgICB0aGlzLm9uZVNpZ25hdHVyZSA9IHJlYWRWYXJTbGljZSgpXG4gICAgcmV0dXJuIG9mZnNldFxuICB9XG5cbiAgX19ieXRlTGVuZ3RoKClcbiAge1xuICAgIHJldHVybiAxICsgXG4gICAgICAgICAgIHZhcnVpbnQuZW5jb2RpbmdMZW5ndGgodGhpcy5wdWJLZXlEYXRhLmxlbmd0aCkgKyB0aGlzLnB1YktleURhdGEubGVuZ3RoICsgXG4gICAgICAgICAgIHZhcnVpbnQuZW5jb2RpbmdMZW5ndGgodGhpcy5vbmVTaWduYXR1cmUubGVuZ3RoKSArIHRoaXMub25lU2lnbmF0dXJlLmxlbmd0aFxuICB9XG5cbiAgdG9CdWZmZXIoYnVmZmVyLCBpbml0aWFsT2Zmc2V0KVxuICB7XG4gICAgdmFyIG5vQnVmZmVyID0gIWJ1ZmZlcjtcbiAgICBpZiAobm9CdWZmZXIpIGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSh0aGlzLl9fYnl0ZUxlbmd0aCgpKVxuICAgIHZhciBvZmZzZXQgPSBpbml0aWFsT2Zmc2V0IHx8IDBcbiAgICBmdW5jdGlvbiB3cml0ZVNsaWNlIChzbGljZSkgeyBvZmZzZXQgKz0gc2xpY2UuY29weShidWZmZXIsIG9mZnNldCkgfVxuICAgIGZ1bmN0aW9uIHdyaXRlVUludDggKGkpIHsgb2Zmc2V0ID0gYnVmZmVyLndyaXRlVUludDgoaSwgb2Zmc2V0KSB9XG4gICAgZnVuY3Rpb24gd3JpdGVWYXJJbnQgKGkpIHtcbiAgICAgIHZhcnVpbnQuZW5jb2RlKGksIGJ1ZmZlciwgb2Zmc2V0KVxuICAgICAgb2Zmc2V0ICs9IHZhcnVpbnQuZW5jb2RlLmJ5dGVzXG4gICAgfVxuICAgIGZ1bmN0aW9uIHdyaXRlVmFyU2xpY2UgKHNsaWNlKSB7IHdyaXRlVmFySW50KHNsaWNlLmxlbmd0aCk7IHdyaXRlU2xpY2Uoc2xpY2UpIH1cblxuICAgIHdyaXRlVUludDgodGhpcy5zaWdUeXBlKVxuICAgIHdyaXRlVmFyU2xpY2UodGhpcy5wdWJLZXlEYXRhKVxuICAgIHdyaXRlVmFyU2xpY2UodGhpcy5vbmVTaWduYXR1cmUpXG5cbiAgICAvLyBhdm9pZCBzbGljaW5nIHVubGVzcyBuZWNlc3NhcnlcbiAgICBpZiAoaW5pdGlhbE9mZnNldCAhPT0gdW5kZWZpbmVkKSByZXR1cm4gbm9CdWZmZXIgPyBidWZmZXIuc2xpY2UoaW5pdGlhbE9mZnNldCwgb2Zmc2V0KSA6IG9mZnNldFxuICAgIC8vIFRPRE8gKGh0dHBzOi8vZ2l0aHViLmNvbS9CaXRHby9iaXRnby11dHhvLWxpYi9pc3N1ZXMvMTEpOiB3ZSBzaG91bGRuJ3QgaGF2ZSB0byBzbGljZSB0aGUgZmluYWwgYnVmZmVyXG4gICAgcmV0dXJuIG5vQnVmZmVyID8gYnVmZmVyLnNsaWNlKDAsIG9mZnNldCkgOiBvZmZzZXRcbiAgfVxufVxuXG5jbGFzcyBTbWFydFRyYW5zYWN0aW9uU2lnbmF0dXJlcyB7XG4gIGNvbnN0cnVjdG9yKHZlcnNpb24gPSAxLCBzaWdIYXNoVHlwZSA9IDEsIHNpZ25hdHVyZXMpIHtcbiAgICB0aGlzLnZlcnNpb24gPSB2ZXJzaW9uXG4gICAgdGhpcy5zaWdIYXNoVHlwZSA9IHNpZ0hhc2hUeXBlXG4gICAgdGhpcy5zaWduYXR1cmVzID0gc2lnbmF0dXJlcyA/IHNpZ25hdHVyZXMgOiBbXVxuICB9XG5cbiAgaXNWYWxpZCgpXG4gIHtcbiAgICByZXR1cm4gdGhpcy52ZXJzaW9uID4gMCAmJiB0aGlzLnZlcnNpb24gPCAyICYmIGJzY3JpcHQuaXNEZWZpbmVkSGFzaFR5cGUodGhpcy5zaWdIYXNoVHlwZSkgJiYgdGhpcy5zaWduYXR1cmVzLmxlbmd0aCA+IDBcbiAgfVxuXG4gIF9fYnl0ZUxlbmd0aCgpXG4gIHtcbiAgICByZXR1cm4gdGhpcy5zaWduYXR1cmVzLnJlZHVjZShmdW5jdGlvbiAoYSwgeCkgeyByZXR1cm4gYSArIHguX19ieXRlTGVuZ3RoKCkgfSwgMiArIHZhcnVpbnQuZW5jb2RpbmdMZW5ndGgodGhpcy5zaWduYXR1cmVzLmxlbmd0aCkpXG4gIH1cblxuICBtaW5MZW5ndGgoKVxuICB7XG4gICAgY2hlY2tTaWdzID0gbmV3IFNtYXJ0VHJhbnNhY3Rpb25TaWduYXR1cmVzKClcbiAgICByZXR1cm4gY2hlY2tTaWdzLl9fYnl0ZUxlbmd0aCgpXG4gIH1cblxuICB0b0J1ZmZlcihidWZmZXIsIGluaXRpYWxPZmZzZXQpXG4gIHtcbiAgICB2YXIgbm9CdWZmZXIgPSAhYnVmZmVyO1xuICAgIGlmIChub0J1ZmZlcikgYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKHRoaXMuX19ieXRlTGVuZ3RoKCkpXG4gICAgdmFyIG9mZnNldCA9IGluaXRpYWxPZmZzZXQgfHwgMFxuICAgIGZ1bmN0aW9uIHdyaXRlU2xpY2UgKHNsaWNlKSB7IG9mZnNldCArPSBzbGljZS5jb3B5KGJ1ZmZlciwgb2Zmc2V0KSB9XG4gICAgZnVuY3Rpb24gd3JpdGVVSW50OCAoaSkgeyBvZmZzZXQgPSBidWZmZXIud3JpdGVVSW50OChpLCBvZmZzZXQpIH1cbiAgICBmdW5jdGlvbiB3cml0ZVZhckludCAoaSkge1xuICAgICAgdmFydWludC5lbmNvZGUoaSwgYnVmZmVyLCBvZmZzZXQpXG4gICAgICBvZmZzZXQgKz0gdmFydWludC5lbmNvZGUuYnl0ZXNcbiAgICB9XG4gICAgZnVuY3Rpb24gd3JpdGVWYXJTbGljZSAoc2xpY2UpIHsgd3JpdGVWYXJJbnQoc2xpY2UubGVuZ3RoKTsgd3JpdGVTbGljZShzbGljZSkgfVxuICAgIGZ1bmN0aW9uIHdyaXRlVmVjdG9yKHZlY3Rvcikge1xuICAgICAgdGhpcy53cml0ZVZhckludCh2ZWN0b3IubGVuZ3RoKTtcbiAgICAgIHZlY3Rvci5mb3JFYWNoKChidWYpID0+IHRoaXMud3JpdGVWYXJTbGljZShidWYpKTtcbiAgICB9XG5cbiAgICB3cml0ZVVJbnQ4KHRoaXMudmVyc2lvbilcbiAgICB3cml0ZVVJbnQ4KHRoaXMuc2lnSGFzaFR5cGUpXG4gICAgd3JpdGVWYXJJbnQodGhpcy5zaWduYXR1cmVzID8gdGhpcy5zaWduYXR1cmVzLmxlbmd0aCA6IDApXG4gICAgdGhpcy5zaWduYXR1cmVzLmFycmF5LmZvckVhY2goeCA9PiBcbiAgICAgIHsgXG4gICAgICAgIG9mZnNldCA9IHgudG9CdWZmZXIoYnVmZmVyLCBvZmZzZXQpXG4gICAgICB9KVxuXG4gICAgLy8gYXZvaWQgc2xpY2luZyB1bmxlc3MgbmVjZXNzYXJ5XG4gICAgaWYgKGluaXRpYWxPZmZzZXQgIT09IHVuZGVmaW5lZCkgcmV0dXJuIG5vQnVmZmVyID8gYnVmZmVyLnNsaWNlKGluaXRpYWxPZmZzZXQsIG9mZnNldCkgOiBvZmZzZXRcbiAgICAvLyBUT0RPIChodHRwczovL2dpdGh1Yi5jb20vQml0R28vYml0Z28tdXR4by1saWIvaXNzdWVzLzExKTogd2Ugc2hvdWxkbid0IGhhdmUgdG8gc2xpY2UgdGhlIGZpbmFsIGJ1ZmZlclxuICAgIHJldHVybiBub0J1ZmZlciA/IGJ1ZmZlci5zbGljZSgwLCBvZmZzZXQpIDogb2Zmc2V0XG4gIH1cbiAgXG4gIGZyb21CdWZmZXIoYnVmZmVyLCBpbml0aWFsT2Zmc2V0KVxuICB7XG4gICAgdmFyIG9mZnNldCA9IGluaXRpYWxPZmZzZXQgfHwgMFxuXG4gICAgZnVuY3Rpb24gcmVhZFVJbnQ4ICgpIHtcbiAgICAgIHZhciBpID0gYnVmZmVyLnJlYWRVSW50OChvZmZzZXQpXG4gICAgICBvZmZzZXQgKz0gMVxuICAgICAgcmV0dXJuIGlcbiAgICB9XG4gIFxuICAgIGZ1bmN0aW9uIHJlYWRWYXJJbnQgKCkge1xuICAgICAgdmFyIHZpID0gdmFydWludC5kZWNvZGUoYnVmZmVyLCBvZmZzZXQpXG4gICAgICBvZmZzZXQgKz0gdmFydWludC5kZWNvZGUuYnl0ZXNcbiAgICAgIHJldHVybiB2aVxuICAgIH1cbiAgXG4gICAgZnVuY3Rpb24gcmVhZE9uZVNpZygpXG4gICAge1xuICAgICAgdmFyIG9uZVNpZyA9IG5ldyBTbWFydFRyYW5zYWN0aW9uU2lnbmF0dXJlKClcbiAgICAgIG9mZnNldCA9IG9uZVNpZy5mcm9tQnVmZmVyKGJ1ZmZlciwgb2Zmc2V0KVxuICAgICAgcmV0dXJuIG9uZVNpZ1xuICAgIH1cbiAgXG4gICAgdHJ5IHtcbiAgICAgIGlmIChidWZmZXIubGVuZ3RoIDwgdGhpcy5taW5MZW5ndGgoKSlcbiAgICAgIHtcbiAgICAgICAgcmV0dXJuIGluaXRpYWxPZmZzZXQgfHwgMFxuICAgICAgfVxuICBcbiAgICAgIHRoaXMudmVyc2lvbiA9IHJlYWRVSW50OCgpXG4gICAgICB0aGlzLnNpZ0hhc2hUeXBlID0gcmVhZFVJbnQ4KClcblxuICAgICAgaWYgKCEodGhpcy52ZXJzaW9uID4gMCAmJiB0aGlzLnZlcnNpb24gPCAyICYmIGJzY3JpcHQuaXNEZWZpbmVkSGFzaFR5cGUodGhpcy5zaWdIYXNoVHlwZSkpKVxuICAgICAge1xuICAgICAgICByZXR1cm4gaW5pdGlhbE9mZnNldCB8fCAwXG4gICAgICB9XG4gIFxuICAgICAgdGhpcy5zaWduYXR1cmVzID0gdGhpcy5zaWduYXR1cmVzID8/IFtdXG4gICAgICBmb3IgKGxldCBudW1TaWduYXR1cmVzID0gcmVhZFZhckludCgpOyBudW1TaWduYXR1cmVzID4gMDsgbnVtU2lnbmF0dXJlcy0tKVxuICAgICAge1xuICAgICAgICB0aGlzLnNpZ25hdHVyZXNbdGhpcy5zaWduYXR1cmVzLmxlbmd0aF0gPSByZWFkT25lU2lnKClcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy52ZXJzaW9uID0gMFxuICAgICAgcmV0dXJuIGluaXRpYWxPZmZzZXQgfHwgMFxuICAgIH1cbiAgICByZXR1cm4gb2Zmc2V0XG4gIH1cbn1cblxuZnVuY3Rpb24gY2hlY2sgKGNodW5rcykge1xuICBpZiAoY2h1bmtzLmxlbmd0aCAhPSAxKSByZXR1cm4gZmFsc2VcblxuICBjaGVja1NpZ3MgPSBuZXcgU21hcnRUcmFuc2FjdGlvblNpZ25hdHVyZXMoKTtcbiAgY2hlY2tTaWdzLmZyb21CdWZmZXIoY2h1bmtzWzBdKVxuICByZXR1cm4gY2hlY2tTaWdzLmlzVmFsaWQoKTtcbn1cbmNoZWNrLnRvSlNPTiA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICdzbWFydCB0cmFuc2FjdGlvbiBpbnB1dCcgfVxuXG52YXIgRU1QVFlfQlVGRkVSID0gQnVmZmVyLmFsbG9jVW5zYWZlKDApXG5cbmZ1bmN0aW9uIGVuY29kZVN0YWNrIChzaWduYXR1cmVzLCBzY3JpcHRQdWJLZXkpIHtcbiAgdHlwZWZvcmNlKFtwYXJ0aWFsU2lnbmF0dXJlXSwgc2lnbmF0dXJlcylcblxuICBpZiAoc2NyaXB0UHViS2V5KSB7XG4gICAgdmFyIHNjcmlwdERhdGEgPSBwMnN0by5kZWNvZGUoc2NyaXB0UHViS2V5KVxuXG4gICAgaWYgKHNpZ25hdHVyZXMubGVuZ3RoIDwgc2NyaXB0RGF0YS5tKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdOb3QgZW5vdWdoIHNpZ25hdHVyZXMgcHJvdmlkZWQnKVxuICAgIH1cblxuICAgIGlmIChzaWduYXR1cmVzLmxlbmd0aCA+IHNjcmlwdERhdGEucHViS2V5cy5sZW5ndGgpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1RvbyBtYW55IHNpZ25hdHVyZXMgcHJvdmlkZWQnKVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBbXS5jb25jYXQoRU1QVFlfQlVGRkVSLCBzaWduYXR1cmVzLm1hcChmdW5jdGlvbiAoc2lnKSB7XG4gICAgaWYgKHNpZyA9PT0gT1BTLk9QXzApIHtcbiAgICAgIHJldHVybiBFTVBUWV9CVUZGRVJcbiAgICB9XG4gICAgcmV0dXJuIHNpZ1xuICB9KSlcbn1cblxuZnVuY3Rpb24gZW5jb2RlIChzaWduYXR1cmVzLCBzY3JpcHRQdWJLZXkpIHtcbiAgcmV0dXJuIGJzY3JpcHQuY29tcGlsZShlbmNvZGVTdGFjayhzaWduYXR1cmVzLCBzY3JpcHRQdWJLZXkpKVxufVxuXG5mdW5jdGlvbiBkZWNvZGVTdGFjayAoc3RhY2ssIGFsbG93SW5jb21wbGV0ZSkge1xuICB0eXBlZm9yY2UoY2hlY2ssIHN0YWNrLCBhbGxvd0luY29tcGxldGUpXG4gIHJldHVybiBzdGFjay5zbGljZSgxKVxufVxuXG5mdW5jdGlvbiBkZWNvZGUgKGJ1ZmZlciwgYWxsb3dJbmNvbXBsZXRlKSB7XG4gIHZhciBzdGFjayA9IGJzY3JpcHQuZGVjb21waWxlKGJ1ZmZlcilcbiAgcmV0dXJuIGRlY29kZVN0YWNrKHN0YWNrLCBhbGxvd0luY29tcGxldGUpXG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBjaGVjazogY2hlY2ssXG4gIGRlY29kZTogZGVjb2RlLFxuICBkZWNvZGVTdGFjazogZGVjb2RlU3RhY2ssXG4gIGVuY29kZTogZW5jb2RlLFxuICBlbmNvZGVTdGFjazogZW5jb2RlU3RhY2tcbn1cbiJdfQ==